# initialize autoconf
AC_INIT(configure.in)

# blurb
echo "CC=$CC"
echo "CCFLAGS=$CCFLAGS"
echo "CXX=$CXX"
echo "CXXFLAGS=$CXXFLAGS"
echo "TXXFLAGS=$TXXFLAGS"

## we need to use the scripts in ./shell
#no_we_dont AC_CONFIG_AUX_DIR(shell)

#--------------------------------------------------------------------------------
# COMPILERS

# check the C compiler
AC_PROG_CC

# check the Fortran compiler
F77="g77" # FIXME:autoconf 2.12 doesn't recognise AC_PROG_F77

# check the C++ compiler
AC_PROG_CXX

# check the C++ preprocessor
AC_PROG_CXXCPP

# remember these
given_CXXFLAGS="$CXXFLAGS"; export given_CXXFLAGS
given_TXXFLAGS="$TXXFLAGS"; export given_TXXFLAGS
#echo "Compiling non-template code  with: $CXX $CXXFLAGS";
#echo "Compiling template instances with: $CXX $TXXFLAGS";

## check for known compilers
#FMK_CXX_IS_EGCS
#FMK_CXX_IS_SUNPRO50
#FMK_CXX_IS_NATIVE_SGI7

#where to find c++ standard headers?
#gettimeofday

#--------------------------------------------------------------------------------
# MANUAL OPTIONS

# use native STL? default is yes.
AC_ARG_ENABLE(emulation-stl,
[  --enable-emulation-stl  use the STL that comes with vcl],
[VCL_USE_NATIVE_STL=0],
[VCL_USE_NATIVE_STL=1])

# use native complex<>? default is yes.
AC_ARG_ENABLE(emulation-complex,
[  --enable-emulation-complex  use the complex<> that comes with vcl],
[VCL_USE_NATIVE_COMPLEX=0],
[VCL_USE_NATIVE_COMPLEX=1])

# use double instead of long double? default is no.
AC_ARG_ENABLE(long-double,
[  --disable-long-double  use double instead of long double],
[VCL_USE_LONG_DOUBLE=0],
[VCL_USE_LONG_DOUBLE=1])

#--------------------------------------------------------------------------------
# COMPILER CHARACTERISTICS


## syntax
AC_CXX_HAS_BOOL

AC_CXX_HAS_TYPENAME

AC_CXX_HAS_MUTABLE

AC_CXX_HAS_EXPLICIT

AC_CXX_HAS_DYNAMIC_CAST

AC_CXX_CHECK_FOR_SCOPE

AC_CXX_DEFAULT_VALUE

AC_CXX_HAS_MEMBER_TEMPLATES

AC_CXX_CAN_DO_PARTIAL_SPECIALIZATION

AC_CXX_DEFINE_SPECIALIZATION

AC_CXX_ALLOWS_INLINE_INSTANTIATION

if test "$VCL_ALLOWS_INLINE_INSTANTIATION" = "1"; then
AC_CXX_NEEDS_INLINE_INSTANTIATION
else
VCL_NEEDS_INLINE_INSTANTIATION="0";
export VCL_NEEDS_INLINE_INSTANTIATION;
fi

#AC_SUBST(VCL_DO_NOT_INSTANTIATE)

#AC_SUBST(VCL_UNINSTANTIATE_SPECIALIZATION)

#AC_SUBST(VCL_UNINSTANTIATE_UNSEEN_SPECIALIZATION)

AC_CXX_STATIC_CONST_INIT_INT

AC_CXX_STATIC_CONST_INIT_FLOAT

AC_CXX_IMPLEMENT_STATIC_CONSTS

AC_CXX_CAN_DO_STATIC_TEMPLATE_MEMBER

AC_CXX_CAN_DO_NON_TYPE_FUNCTION_TEMPLATE_PARAMETER

AC_CXX_NEED_FRIEND_FOR_TEMPLATE_OVERLOAD

AC_CXX_OVERLOAD_CAST

AC_CXX_NULL_TMPL_ARGS

AC_CXX_NO_STATIC_DATA_MEMBERS

AC_CXX_HAS_TEMPLATE_SYMBOLS


#VCL_DFL_TYPE_PARAM_STLDECL
#VCL_DFL_TMPL_PARAM_STLDECL
#VCL_DFL_TMPL_ARG
AC_CXX_CAN_DO_COMPLETE_DEFAULT_TYPE_PARAMETER
if test "$VCL_CAN_DO_COMPLETE_DEFAULT_TYPE_PARAMETER" = "1"; then
AC_CXX_CAN_DO_TEMPLATE_DEFAULT_TYPE_PARAMETER
else
VCL_CAN_DO_TEMPLATE_DEFAULT_TYPE_PARAMETER="0";
export VCL_CAN_DO_TEMPLATE_DEFAULT_TYPE_PARAMETER;
fi
#AC_CXX_DEFAULT_TMPL_ARG

AC_CXX_SUNPRO_CLASS_SCOPE_HACK

AC_CXX_HAS_EXCEPTIONS

AC_CXX_HAS_NAMESPACES

AC_CXX_ALLOWS_NAMESPACE_STD

if test "$VCL_ALLOWS_NAMESPACE_STD" = "1"; then
AC_CXX_NEEDS_NAMESPACE_STD
else
VCL_NEEDS_NAMESPACE_STD="0"; export VCL_NEEDS_NAMESPACE_STD
fi


## architecture
AC_C_BIGENDIAN
if test "$ac_cv_c_bigendian" = "yes"; then
  VCL_BIG_ENDIAN=1;
  VCL_LITTLE_ENDIAN=0;
else
  VCL_BIG_ENDIAN=0;
  VCL_LITTLE_ENDIAN=1;
fi
export VCL_BIG_ENDIAN
export VCL_LITTLE_ENDIAN




ifelse([],[],[
## standard header files.
AC_CXX_HAS_HEADER(cassert,VCL_CXX_HAS_HEADER_CASSERT)
AC_CXX_HAS_HEADER(ciso646,VCL_CXX_HAS_HEADER_CISO646)
AC_CXX_HAS_HEADER(csetjmp,VCL_CXX_HAS_HEADER_CSETJMP)
AC_CXX_HAS_HEADER(cstdio,VCL_CXX_HAS_HEADER_CSTDIO)
AC_CXX_HAS_HEADER(ctime,VCL_CXX_HAS_HEADER_CTIME)
AC_CXX_HAS_HEADER(cctype,VCL_CXX_HAS_HEADER_CCTYPE)
AC_CXX_HAS_HEADER(climits,VCL_CXX_HAS_HEADER_CLIMITS)
AC_CXX_HAS_HEADER(csignal,VCL_CXX_HAS_HEADER_CSIGNAL)
AC_CXX_HAS_HEADER(cstdlib,VCL_CXX_HAS_HEADER_CSTDLIB)
AC_CXX_HAS_HEADER(cwchar,VCL_CXX_HAS_HEADER_CWCHAR)
AC_CXX_HAS_HEADER(cerrno,VCL_CXX_HAS_HEADER_CERRNO)
AC_CXX_HAS_HEADER(clocale,VCL_CXX_HAS_HEADER_CLOCALE)
AC_CXX_HAS_HEADER(cstdarg,VCL_CXX_HAS_HEADER_CSTDARG)
AC_CXX_HAS_HEADER(cstring,VCL_CXX_HAS_HEADER_CSTRING)
AC_CXX_HAS_HEADER(cwctype,VCL_CXX_HAS_HEADER_CWCTYPE)
AC_CXX_HAS_HEADER(cfloat,VCL_CXX_HAS_HEADER_CFLOAT)
AC_CXX_HAS_HEADER(cmath,VCL_CXX_HAS_HEADER_CMATH)
AC_CXX_HAS_HEADER(cstddef,VCL_CXX_HAS_HEADER_CSTDDEF)
AC_CXX_HAS_HEADER(algorithm,VCL_CXX_HAS_HEADER_ALGORITHM)
AC_CXX_HAS_HEADER(iomanip,VCL_CXX_HAS_HEADER_IOMANIP)
AC_CXX_HAS_HEADER(list,VCL_CXX_HAS_HEADER_LIST)
AC_CXX_HAS_HEADER(ostream,VCL_CXX_HAS_HEADER_OSTREAM)
AC_CXX_HAS_HEADER(streambuf,VCL_CXX_HAS_HEADER_STREAMBUF)
AC_CXX_HAS_HEADER(bitset,VCL_CXX_HAS_HEADER_BITSET)
AC_CXX_HAS_HEADER(ios,VCL_CXX_HAS_HEADER_IOS)
AC_CXX_HAS_HEADER(locale,VCL_CXX_HAS_HEADER_LOCALE)
AC_CXX_HAS_HEADER(queue,VCL_CXX_HAS_HEADER_QUEUE)
AC_CXX_HAS_HEADER(string,VCL_CXX_HAS_HEADER_STRING)
AC_CXX_HAS_HEADER(complex,VCL_CXX_HAS_HEADER_COMPLEX)
AC_CXX_HAS_HEADER(iosfwd,VCL_CXX_HAS_HEADER_IOSFWD)
AC_CXX_HAS_HEADER(map,VCL_CXX_HAS_HEADER_MAP)
AC_CXX_HAS_HEADER(set,VCL_CXX_HAS_HEADER_SET)
AC_CXX_HAS_HEADER(typeinfo,VCL_CXX_HAS_HEADER_TYPEINFO)
AC_CXX_HAS_HEADER(deque,VCL_CXX_HAS_HEADER_DEQUE)
AC_CXX_HAS_HEADER(iostream,VCL_CXX_HAS_HEADER_IOSTREAM)
AC_CXX_HAS_HEADER(memory,VCL_CXX_HAS_HEADER_MEMORY)
AC_CXX_HAS_HEADER(sstream,VCL_CXX_HAS_HEADER_SSTREAM)
AC_CXX_HAS_HEADER(utility,VCL_CXX_HAS_HEADER_UTILITY)
AC_CXX_HAS_HEADER(exception,VCL_CXX_HAS_HEADER_EXCEPTION)
AC_CXX_HAS_HEADER(istream,VCL_CXX_HAS_HEADER_ISTREAM)
AC_CXX_HAS_HEADER(new,VCL_CXX_HAS_HEADER_NEW)
AC_CXX_HAS_HEADER(stack,VCL_CXX_HAS_HEADER_STACK)
AC_CXX_HAS_HEADER(valarray,VCL_CXX_HAS_HEADER_VALARRAY)
AC_CXX_HAS_HEADER(fstream,VCL_CXX_HAS_HEADER_FSTREAM)
AC_CXX_HAS_HEADER(iterator,VCL_CXX_HAS_HEADER_ITERATOR)
AC_CXX_HAS_HEADER(numeric,VCL_CXX_HAS_HEADER_NUMERIC)
AC_CXX_HAS_HEADER(stdexcept,VCL_CXX_HAS_HEADER_STDEXCEPT)
AC_CXX_HAS_HEADER(vector,VCL_CXX_HAS_HEADER_VECTOR)
AC_CXX_HAS_HEADER(functional,VCL_CXX_HAS_HEADER_FUNCTIONAL)
AC_CXX_HAS_HEADER(limits,VCL_CXX_HAS_HEADER_LIMITS)
AC_CXX_HAS_HEADER(strstream,VCL_CXX_HAS_HEADER_STRSTREAM)
])

#--------------------------------------------------------------------------------
# SUBSTITUTIONS

# manual
AC_SUBST(VCL_USE_NATIVE_STL)
AC_SUBST(VCL_USE_NATIVE_COMPLEX)
AC_SUBST(VCL_USE_LONG_DOUBLE)

# compiler
AC_SUBST(VCL_HAS_BOOL)
AC_SUBST(VCL_HAS_DYNAMIC_CAST)
AC_SUBST(VCL_HAS_TYPENAME)
AC_SUBST(VCL_HAS_MUTABLE)
AC_SUBST(VCL_HAS_EXPLICIT)
AC_SUBST(VCL_STATIC_CONST_INIT_INT)
AC_SUBST(VCL_STATIC_CONST_INIT_FLOAT)
AC_SUBST(VCL_IMPLEMENT_STATIC_CONSTS)
AC_SUBST(VCL_FOR_SCOPE_HACK)
AC_SUBST(VCL_HAS_MEMBER_TEMPLATES)
AC_SUBST(VCL_CAN_DO_PARTIAL_SPECIALIZATION)
AC_SUBST(VCL_ALLOWS_INLINE_INSTANTIATION)
AC_SUBST(VCL_NEEDS_INLINE_INSTANTIATION)
#AC_SUBST(VCL_DO_NOT_INSTANTIATE)
#AC_SUBST(VCL_UNINSTANTIATE_SPECIALIZATION)
#AC_SUBST(VCL_UNINSTANTIATE_UNSEEN_SPECIALIZATION) # dubious
AC_SUBST(VCL_CAN_DO_STATIC_TEMPLATE_MEMBER)
AC_SUBST(VCL_CAN_DO_NON_TYPE_FUNCTION_TEMPLATE_PARAMETER)
AC_SUBST(VCL_NEED_FRIEND_FOR_TEMPLATE_OVERLOAD)
AC_SUBST(VCL_OVERLOAD_CAST)
AC_SUBST(VCL_DEFINE_SPECIALIZATION)
AC_SUBST(VCL_NULL_TMPL_ARGS)
AC_SUBST(VCL_DEFAULT_VALUE)
AC_SUBST(VCL_NO_STATIC_DATA_MEMBERS)
AC_SUBST(VCL_HAS_TEMPLATE_SYMBOLS)
#
AC_SUBST(VCL_DEFAULT_TMPL_ARG)
AC_SUBST(VCL_CAN_DO_COMPLETE_DEFAULT_TYPE_PARAMETER)
AC_SUBST(VCL_CAN_DO_TEMPLATE_DEFAULT_TYPE_PARAMETER)
AC_SUBST(VCL_SUNPRO_CLASS_SCOPE_HACK)
#
AC_SUBST(VCL_HAS_EXCEPTIONS)
AC_SUBST(VCL_HAS_NAMESPACES)
AC_SUBST(VCL_ALLOWS_NAMESPACE_STD)
AC_SUBST(VCL_NEEDS_NAMESPACE_STD)
#
AC_SUBST(VCL_BIG_ENDIAN)
AC_SUBST(VCL_LITTLE_ENDIAN)

# standard header files.
AC_SUBST(VCL_CXX_HAS_HEADER_CASSERT)
AC_SUBST(VCL_CXX_HAS_HEADER_CISO646)
AC_SUBST(VCL_CXX_HAS_HEADER_CSETJMP)
AC_SUBST(VCL_CXX_HAS_HEADER_CSTDIO)
AC_SUBST(VCL_CXX_HAS_HEADER_CTIME)
AC_SUBST(VCL_CXX_HAS_HEADER_CCTYPE)
AC_SUBST(VCL_CXX_HAS_HEADER_CLIMITS)
AC_SUBST(VCL_CXX_HAS_HEADER_CSIGNAL)
AC_SUBST(VCL_CXX_HAS_HEADER_CSTDLIB)
AC_SUBST(VCL_CXX_HAS_HEADER_CWCHAR)
AC_SUBST(VCL_CXX_HAS_HEADER_CERRNO)
AC_SUBST(VCL_CXX_HAS_HEADER_CLOCALE)
AC_SUBST(VCL_CXX_HAS_HEADER_CSTDARG)
AC_SUBST(VCL_CXX_HAS_HEADER_CSTRING)
AC_SUBST(VCL_CXX_HAS_HEADER_CWCTYPE)
AC_SUBST(VCL_CXX_HAS_HEADER_CFLOAT)
AC_SUBST(VCL_CXX_HAS_HEADER_CMATH)
AC_SUBST(VCL_CXX_HAS_HEADER_CSTDDEF)
AC_SUBST(VCL_CXX_HAS_HEADER_ALGORITHM)
AC_SUBST(VCL_CXX_HAS_HEADER_IOMANIP)
AC_SUBST(VCL_CXX_HAS_HEADER_LIST)
AC_SUBST(VCL_CXX_HAS_HEADER_OSTREAM)
AC_SUBST(VCL_CXX_HAS_HEADER_STREAMBUF)
AC_SUBST(VCL_CXX_HAS_HEADER_BITSET)
AC_SUBST(VCL_CXX_HAS_HEADER_IOS)
AC_SUBST(VCL_CXX_HAS_HEADER_LOCALE)
AC_SUBST(VCL_CXX_HAS_HEADER_QUEUE)
AC_SUBST(VCL_CXX_HAS_HEADER_STRING)
AC_SUBST(VCL_CXX_HAS_HEADER_COMPLEX)
AC_SUBST(VCL_CXX_HAS_HEADER_IOSFWD)
AC_SUBST(VCL_CXX_HAS_HEADER_MAP)
AC_SUBST(VCL_CXX_HAS_HEADER_SET)
AC_SUBST(VCL_CXX_HAS_HEADER_TYPEINFO)
AC_SUBST(VCL_CXX_HAS_HEADER_DEQUE)
AC_SUBST(VCL_CXX_HAS_HEADER_IOSTREAM)
AC_SUBST(VCL_CXX_HAS_HEADER_MEMORY)
AC_SUBST(VCL_CXX_HAS_HEADER_SSTREAM)
AC_SUBST(VCL_CXX_HAS_HEADER_UTILITY)
AC_SUBST(VCL_CXX_HAS_HEADER_EXCEPTION)
AC_SUBST(VCL_CXX_HAS_HEADER_ISTREAM)
AC_SUBST(VCL_CXX_HAS_HEADER_NEW)
AC_SUBST(VCL_CXX_HAS_HEADER_STACK)
AC_SUBST(VCL_CXX_HAS_HEADER_VALARRAY)
AC_SUBST(VCL_CXX_HAS_HEADER_FSTREAM)
AC_SUBST(VCL_CXX_HAS_HEADER_ITERATOR)
AC_SUBST(VCL_CXX_HAS_HEADER_NUMERIC)
AC_SUBST(VCL_CXX_HAS_HEADER_STDEXCEPT)
AC_SUBST(VCL_CXX_HAS_HEADER_VECTOR)
AC_SUBST(VCL_CXX_HAS_HEADER_FUNCTIONAL)
AC_SUBST(VCL_CXX_HAS_HEADER_LIMITS)
AC_SUBST(VCL_CXX_HAS_HEADER_STRSTREAM)

#--------------------------------------------------------------------------------
# OUTPUT

AC_OUTPUT(
vcl_config_manual.h~:vcl_config_manual.h.in
vcl_config_compiler.h~:vcl_config_compiler.h.in
vcl_config_headers.h~:vcl_config_headers.h.in
)

# only touch files that actually change.
for f in "vcl_config_manual.h" "vcl_config_compiler.h" "vcl_config_headers.h"; do
  if test -f $f; then
    if diff ${f} ${f}~ 2>&1 >/dev/null ; then
      echo "no change to ${f}"
      rm -f ${f}~
    else
      echo "replacing old ${f}"
      mv -f ${f}~ ${f}
    fi
  else
    echo "creating new ${f}"
    mv -f ${f}~ ${f}
  fi
done
